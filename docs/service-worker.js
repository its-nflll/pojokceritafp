importScripts("https://storage.googleapis.com/workbox-cdn/releases/6.5.4/workbox-sw.js"),importScripts("./idb-helper.js");const CACHE_VERSION="v3";self.addEventListener("push",(function(e){let t={title:"PojokCerita",options:{body:"Ada notifikasi baru!",icon:"/images/logo.png",badge:"/favicon.png",data:{}}};if(e.data)try{const o=e.data.json();t={title:o.title||t.title,options:{...t.options,body:o.options?.body||t.options.body,data:o}}}catch(e){console.error("Error parsing push data:",e)}e.waitUntil(self.registration.showNotification(t.title,t.options))})),self.addEventListener("notificationclick",(e=>{e.notification.close();const t=new URL("/",self.location.origin).href;e.waitUntil(clients.matchAll({type:"window",includeUncontrolled:!0}).then((e=>{if(!e.some((e=>e.url===t&&(e.focus(),!0))))return clients.openWindow(t)})))})),workbox.routing.registerRoute((({request:e})=>"navigate"===e.mode),new workbox.strategies.NetworkFirst({cacheName:"pages-cache-v3",plugins:[new workbox.expiration.ExpirationPlugin({maxAgeSeconds:604800})]})),workbox.routing.registerRoute((({request:e})=>"script"===e.destination||"style"===e.destination||"worker"===e.destination),new workbox.strategies.StaleWhileRevalidate({cacheName:"assets-cache-v3",plugins:[new workbox.expiration.ExpirationPlugin({maxEntries:60,maxAgeSeconds:2592e3})]})),workbox.routing.registerRoute(new RegExp("/stories($|\\?.*)"),(async({event:e})=>{try{const t=await fetch(e.request);if(t.ok){const e=t.clone(),o=await e.json();try{const e=(await openDB()).transaction("stories","readwrite").objectStore("stories"),t=e.getAll();t.onsuccess=()=>{const s=t.result,r=new Set;s.forEach((e=>{!0===e.isOffline&&r.add(e.id)})),o.listStory.forEach((t=>{r.has(t.id)&&(t.isOffline=!0),e.put(t)}))}}catch(e){console.error("Error updating IndexedDB:",e)}return t}throw new Error("Network response was not ok")}catch(e){const t=await getAllStories();return new Response(JSON.stringify({error:!1,message:"Success (Offline Mode)",listStory:t}))}})),workbox.routing.registerRoute((({request:e})=>"image"===e.destination),new workbox.strategies.NetworkFirst({cacheName:"images-cache-v3",plugins:[new workbox.expiration.ExpirationPlugin({maxEntries:100,maxAgeSeconds:2592e3}),{handlerDidError:async()=>await caches.match("/images/placeholder.png")||new Response("<svg>...</svg>",{headers:{"Content-Type":"image/svg+xml"}})}]}));const defaultHandler=new workbox.strategies.NetworkFirst({cacheName:"documents-cache-v3"});workbox.routing.setDefaultHandler(defaultHandler),workbox.routing.setCatchHandler((async({event:e})=>"document"===e.request.destination?caches.match("/index.html"):Response.error())),self.addEventListener("message",(e=>{if(e.data&&"DELETE_STORY"===e.data.action){const t=e.data.storyId;t?openDB().then((e=>{const o=e.transaction(STORE_NAME,"readonly").objectStore(STORE_NAME);return new Promise(((e,s)=>{const r=o.get(t);r.onsuccess=()=>{r.result?e(!0):s(new Error(`Story with ID ${t} not found`))},r.onerror=()=>s(r.error)}))})).then((()=>deleteStory(t))).then((()=>{console.log(`Story with ID ${t} successfully deleted from service worker`),e.ports&&e.ports[0]&&e.ports[0].postMessage({status:"success",message:"Story deleted from IndexedDB"})})).catch((t=>{console.error("Error deleting story from service worker:",t),e.ports&&e.ports[0]&&e.ports[0].postMessage({status:"error",message:t.message||"Failed to delete story"})})):e.ports&&e.ports[0]&&e.ports[0].postMessage({status:"error",message:"Invalid story ID"})}}));